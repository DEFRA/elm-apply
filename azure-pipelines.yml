trigger:
  - master

pool:
  vmImage: 'ubuntu-latest'

variables:
  azureContainerRegistry: 'mcCntRegistry Connection'
  containerImage: elm-lmp-web:$(Build.BuildId)
  testOutputDir: test-output

steps:
- task: Docker@2
  displayName: Login to Azure Container Registry
  inputs:
    command: login
    containerRegistry: $(azureContainerRegistry)
    repository: elm-lmp-web

- bash: bin/docker/build
  displayName: Build container images
  env:
    CONTAINER_IMAGE: $(containerImage)

- bash: bin/docker/test
  displayName: Test
  env:
    CONTAINER_IMAGE: $(containerImage)
    OUTPUT_DIR: $(testOutputDir)

- task: PublishTestResults@2
  displayName: Publish test results
  inputs:
    testResultsFormat: JUnit
    testResultsFiles: $(testOutputDir)/TEST-*.xml
    failTaskOnFailedTests: true
    testRunTitle: Unit-test

- bash: docker push $(containerImage)
  displayName: Push production image

# - task: Docker@2
#   displayName: Push production container image
#   inputs:
#     command: push
#     containerRegistry: $(azureContainerRegistry)
#     repository: elm-lmp-web
